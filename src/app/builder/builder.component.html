<sqd-designer
  theme="dark"
  [definition]="definition"
  [toolboxConfiguration]="toolboxConfiguration"
  [stepsConfiguration]="stepsConfiguration"
  [validatorConfiguration]="validatorConfiguration"
  [controlBar]="true"
  [areEditorsHidden]="false"
  [rootEditor]="rootEditorProvider"
  [stepEditor]="stepEditorProvider"
  [isToolboxCollapsed]="isToolboxCollapsed"
  [isEditorCollapsed]="isEditorCollapsed"
  (onReady)="onDesignerReady($event)"
  (onDefinitionChanged)="onDefinitionChanged($event)"
>
</sqd-designer>

<div class="block">
	<button mat-raised-button color="primary" (click)="reloadDefinitionClicked()">Reload definition</button>
	&nbsp;
	<button mat-raised-button color="primary" (click)="toggleReadonlyClicked()">
		{{ isReadonly ? 'Enable editing' : 'Disable editing' }}
	</button>
	&nbsp;
	<button mat-raised-button color="primary" (click)="toggleSelectedStepClicked()">
		{{ selectedStepId ? 'Unselect' : 'Select first' }}
	</button>
	&nbsp;
	<button mat-raised-button color="primary" (click)="toggleToolboxClicked()">
		{{ isToolboxCollapsed ? 'Show toolbox' : 'Hide toolbox' }}
	</button>
	&nbsp;
	<button mat-raised-button color="primary" (click)="toggleEditorClicked()">
		{{ isEditorCollapsed ? 'Show editor' : 'Hide editor' }}
	</button>
	&nbsp; Is valid: <strong>{{ isValid }}</strong>
</div>

<ng-template #stepEditorProvider let-editor>
    <div style="padding: 1rem;">
        <h3>{{editor.step.name}}</h3>
    
        <p>Attributes</p>
        <ng-container *ngFor="let key of objectKeys(editor.step.properties)">
          <div *ngIf="isBoolean(editor.step.properties[key]); else fieldCheck" style="display: block; margin-top: 1rem;">
            <mat-slide-toggle [(ngModel)]="editor.step.properties[key]" name="{{ key }}"
                              [disabled]="editor.isReadonly"
                              (change)="updateProperty(editor.step.properties, key, $event, editor.context)">
              {{ key }}
            </mat-slide-toggle>
          </div>
        
          <ng-template #fieldCheck>
            <div *ngIf="isMap(editor.step.properties[key]); else textField" style="display: block; margin-top: 1rem;">
              <button mat-raised-button color="primary" (click)="editMap(editor.step.properties, key, editor.context)">
                Edit {{ key }}
              </button>
            </div>
          </ng-template>
        
          <ng-template #textField>
            <ng-container *ngIf="getChoicesForProperty(editor.step.type, key) as choices; else defaultInput">
              <mat-form-field appearance="fill" style="display: block; margin-top: 1rem;">
                <mat-label>{{ key }}</mat-label>
                <mat-select [(ngModel)]="editor.step.properties[key]" [disabled]="editor.isReadonly" [required]="isRequired(editor.step.type, key)" name="{{ key }}"
                            (selectionChange)="updateProperty(editor.step.properties, key, $event.value, editor.context)">
                  <mat-option *ngFor="let choice of choices" [value]="choice">{{ getChoiceLabel(editor.step.type, choice) }}</mat-option>
                </mat-select>
                <mat-error *ngIf="editor.step.properties[key] === ''">
                  {{ key }} is required
                </mat-error>
              </mat-form-field>
            </ng-container>
        
            <ng-template #defaultInput>
              <mat-form-field appearance="fill" style="display: block; margin-top: 1rem;">
                <mat-label>{{ key }}</mat-label>
                <input matInput [(ngModel)]="editor.step.properties[key]" name="{{ key }}"
                       [readonly]="editor.isReadonly"
                       [required]="isRequired(editor.step.type, key)"
                       (input)="updateProperty(editor.step.properties, key, $event, editor.context)">
                       <mat-error *ngIf="editor.step.properties[key] === ''">
                        {{ key }} is required
                      </mat-error>
              </mat-form-field>
            </ng-template>
          </ng-template>
        </ng-container>
        
          <div *ngIf="editor?.step?.branches">
            <div *ngFor="let branchName of getBranchNames(editor.step.branches); let i = index" class="branch-row">
              <div *ngIf="branchName !== 'input'">
              <mat-form-field appearance="outline" class="branch-field">
                <input matInput [(ngModel)]="branchName" [readonly]="editor.isReadonly" placeholder="Branch Name" (change)="renameBranchAtIndex(editor.step.branches, branchName, $event.target.value, editor.context)"/>
              </mat-form-field>
              <button mat-icon-button color="warn" (click)="removeBranch(editor.step.branches, i, $event, editor.context)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
            </div>
        
            <button mat-stroked-button color="primary" (click)="addBranch(editor.step.branches, editor.context)" *ngIf="branchingEnabled(editor.step)">
              <mat-icon>add</mat-icon>
              Add Branch
            </button>
        </div>
      </div>
  </ng-template>

<div class="block">
	<mat-form-field class="full-width flex-1s">
		<textarea matInput cols="120" rows="16" readonly>{{ definitionJSON }}</textarea>
	</mat-form-field>
</div>