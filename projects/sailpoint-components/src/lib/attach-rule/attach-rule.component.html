<div class="rules-container">
  <mat-toolbar color="primary">
    <mat-icon>attachment</mat-icon>
    <span class="toolbar-title">{{ title }}</span>
  </mat-toolbar>

  <div class="content">
    <ng-template #loading>
      <div class="loading-overlay">
        <mat-spinner></mat-spinner>
      </div>
    </ng-template>

    <ng-container *ngIf="!isLoading; else loading">
      <mat-card class="top-panel">
        <mat-card-content class="top-content">
          <mat-form-field appearance="fill" class="source-field">
            <mat-label>Choose Source</mat-label>
            <mat-select
              [(ngModel)]="selectedSource"
              (selectionChange)="onSourceChange($event.value)"
            >
              <mat-option *ngFor="let s of sources" [value]="s">
                {{ s.name || s.id }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <ng-container *ngIf="selectedSource; else pickOne">
        <div class="rules-grid">
          <div class="available-column">
            <mat-card>
              <mat-card-header>
                <mat-card-title>Available Connector Rules</mat-card-title>
              </mat-card-header>
              <mat-card-content
                cdkDropList
                id="available"
                class="list-container"
                [cdkDropListData]="availableRules"
                [cdkDropListConnectedTo]="slotDropListIds"
                (cdkDropListDropped)="onDrop($event)"
              >
                <div
                  *ngFor="let rule of availableRules"
                  cdkDrag
                  [cdkDragData]="rule"
                  class="rule-card"
                >
                  <mat-icon>drag_handle</mat-icon>
                  {{ rule.name }}
                </div>
                <div *ngIf="availableRules.length === 0" class="empty-slot">
                  No rules available
                </div>
              </mat-card-content>
            </mat-card>
          </div>
          <div class="slots-column">
            <mat-card>
              <mat-card-header>
                <mat-card-title>Rule Slots</mat-card-title>
              </mat-card-header>
              <mat-card-content class="slots-grid">
                <div *ngFor="let slot of slots" class="slot-wrapper">
                  <mat-card class="slot-card">
                    <mat-card-header>
                      <mat-card-title>{{ slot.label }}</mat-card-title>
                    </mat-card-header>
                    <mat-card-content
                      cdkDropList
                      [id]="'assigned-' + slot.key"
                      class="list-container slot-drop"
                      [cdkDropListData]="assignedRulesMap[slot.key] ?? []"
                      [cdkDropListConnectedTo]="availableConnectedTo"
                      (cdkDropListDropped)="onDrop($event)"
                    >
                      <div
                        *ngFor="
                          let assigned of assignedRulesMap[slot.key] ?? []
                        "
                        cdkDrag
                        [cdkDragData]="assigned"
                        class="rule-card"
                      >
                        <mat-icon>drag_handle</mat-icon>
                        <span class="rule-name">{{ assigned.name }}</span>
                        <button
                          mat-icon-button
                          color="warn"
                          aria-label="Remove this rule"
                          (click)="
                            $event.stopPropagation();
                            removeAssignedRule(slot.key, assigned)
                          "
                        >
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>

                      <div
                        *ngIf="(assignedRulesMap[slot.key]?.length ?? 0) === 0"
                        class="empty-slot"
                      >
                        Drop rule here
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>
        <div class="action-bar">
          <button
            mat-raised-button
            color="primary"
            (click)="applyPatches()"
            [disabled]="!pendingOps.length || isSaving"
          >
            {{ isSaving ? "Savingâ€¦" : "Save Changes" }}
          </button>
        </div>
      </ng-container>

      <ng-template #pickOne>
        <p style="text-align: center; color: #666">
          Please select a source to begin assigning rules.
        </p>
      </ng-template>
    </ng-container>
  </div>
</div>
